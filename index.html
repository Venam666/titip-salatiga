<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Titip Salatiga - Sat Set!</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #064E3B; --secondary: #F59E0B; --bg-light: #F3F4F6; --white: #FFFFFF; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-user-select: none; user-select: none; }
        input, textarea, select { user-select: text; }
        body { background-color: var(--bg-light); padding-bottom: 100px; }
        
        .hero { background: linear-gradient(135deg, var(--primary), #022c22); color: var(--white); padding: 40px 20px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; text-align: center; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--secondary); margin-bottom: 10px; }
        
        .instruction { text-align: center; margin-top: 25px; font-weight: 600; color: var(--primary); font-size: 0.9rem; transition: opacity 0.3s; }
        .instruction i { animation: bounce 2s infinite; }

        .services { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px 20px 20px 20px; }
        .card { background: var(--white); padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; border: 2px solid transparent; transition: 0.3s; }
        .card.active { border-color: var(--secondary); background: #FFFBEB; transform: scale(1.05); }
        .card i { font-size: 1.5rem; color: var(--primary); margin-bottom: 10px; }
        .card h3 { font-size: 0.85rem; font-weight: 600; }

        .form-section { padding: 20px; display: none; animation: slideUp 0.5s ease; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px; color: var(--primary); }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; outline: none; font-size: 0.9rem; background: #fff; }
        
        .gps-btn { background: #ECFDF5; color: var(--primary); border: 1px dashed var(--primary); padding: 12px; width: 100%; border-radius: 10px; cursor: pointer; margin-bottom: 10px; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 8px;}
        
        .price-tag { font-size: 1.8rem; font-weight: 700; color: var(--secondary); margin: 10px 0; text-align: center; }
        .fab-container { position: fixed; bottom: 0; left: 0; width: 100%; padding: 15px 20px; background: var(--white); box-shadow: 0 -4px 10px rgba(0,0,0,0.05); display: none; z-index: 100; }
        .btn-wa { background: var(--secondary); color: var(--primary); width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-wa:disabled { background: #ccc; cursor: not-allowed; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-5px);} 60% {transform: translateY(-3px);} }
    </style>
</head>
<body oncontextmenu="return false;">

    <div class="hero">
        <div class="logo"><i class="fas fa-box"></i> TITIP SALATIGA</div>
        <h1>Barang Aman,<br>Liburan Tenang</h1>
        <p>Solusi mudik mahasiswa.</p>
    </div>

    <div class="instruction" id="instructionBox">
        <i class="fas fa-arrow-down"></i> Pilih layanan di bawah ini dulu ya.
    </div>

    <div class="services">
        <!-- Fungsi sel() menerima Nama, Harga Dasar, dan Tipe (duration/fixed) -->
        <div class="card" onclick="sel('Storage', 149000, 'monthly')"><i class="fas fa-warehouse"></i><h3>Titip Barang</h3></div>
        <div class="card" onclick="sel('Moving', 250000, 'fixed')"><i class="fas fa-truck-pickup"></i><h3>Pindahan</h3></div>
        <div class="card" onclick="sel('Luggage', 50000, 'weekly')"><i class="fas fa-suitcase-rolling"></i><h3>Titip Koper</h3></div>
        <div class="card" onclick="sel('Packing', 75000, 'fixed')"><i class="fas fa-box-open"></i><h3>Bantu Packing</h3></div>
    </div>

    <div class="form-section" id="bookingForm">
        <h3 style="margin-bottom: 15px; color: var(--primary);">Form Booking Sat-Set</h3>
        <div class="input-group"><label>Nama Lengkap</label><input type="text" id="userName" placeholder="Nama panggilanmu"></div>
        <div class="input-group"><label>Nomor WhatsApp</label><input type="tel" id="userPhone" placeholder="08xxxxxxxx"></div>
        
        <!-- Field Durasi (Hanya muncul untuk Storage & Luggage) -->
        <div class="input-group" id="durationBox" style="display:none;">
            <label>Durasi Titip</label>
            <select id="userDuration" onchange="calcTotal()">
                <option value="1 Minggu">1 Minggu</option>
                <option value="2 Minggu">2 Minggu</option>
                <option value="3 Minggu">3 Minggu</option>
                <option value="1 Bulan" selected>1 Bulan</option>
                <option value="2 Bulan">2 Bulan</option>
            </select>
        </div>

        <div class="input-group">
            <label>Lokasi Penjemputan</label>
            <button class="gps-btn" id="gBtn" onclick="getGPS()"><i class="fas fa-map-marker-alt"></i> Deteksi Lokasi Saya (GPS)</button>
            <textarea id="userAddress" rows="3" placeholder="Alamat otomatis terisi / ketik manual..."></textarea>
            <p style="font-size: 0.7rem; color: #666; margin-top: 5px;">*Tips: Gunakan GPS di luar ruangan agar lebih akurat.</p>
        </div>

        <div class="input-group"><label>Ancer-ancer / Patokan</label><input type="text" id="userLandmark" placeholder="Contoh: Depan Laundry Biru"></div>
        
        <div class="summary-box" style="text-align:center; margin-top:20px;">
            <h4>Estimasi Biaya</h4>
            <div class="price-tag" id="priceDisplay">Rp 149.000</div>
            <p style="font-size: 0.75rem; color: #888;">*Data otomatis tersimpan di sistem kami.</p>
        </div>
    </div>

    <div class="fab-container" id="fabContainer">
        <button class="btn-wa" id="submitBtn" onclick="handleBooking()">
            <i class="fab fa-whatsapp"></i> Konfirmasi Booking ke WA
        </button>
    </div>

    <!-- SCRIPT 1: LOGIKA UI GLOBAL -->
    <script>
        // Variabel Global
        let sSvc = "";
        let sBasePrc = 0;
        let sTotalPrc = 0;
        let sType = ""; // 'fixed', 'monthly', 'weekly'

        // Fungsi Pilih Layanan
        function sel(name, basePrice, type) {
            sSvc = name; 
            sBasePrc = basePrice;
            sType = type;
            
            // UI Feedback (Card Active)
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // Tampilkan Form & Sembunyikan Instruksi
            document.getElementById('bookingForm').style.display = 'block';
            document.getElementById('fabContainer').style.display = 'block';
            document.getElementById('instructionBox').style.opacity = '0';
            
            // Cek apakah butuh input durasi
            const durBox = document.getElementById('durationBox');
            const durSel = document.getElementById('userDuration');
            
            if (type === 'monthly' || type === 'weekly') {
                durBox.style.display = 'block';
                // Reset select ke default yang logis
                durSel.value = (type === 'monthly') ? "1 Bulan" : "1 Minggu";
            } else {
                durBox.style.display = 'none';
            }
            
            // Hitung Harga Awal
            calcTotal();
            
            // Scroll ke Form
            setTimeout(() => {
                document.getElementById('bookingForm').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // Fungsi Kalkulator Harga
        function calcTotal() {
            const durVal = document.getElementById('userDuration').value;
            let finalPrice = sBasePrc;

            if (sType === 'fixed') {
                finalPrice = sBasePrc;
            } 
            else if (sType === 'monthly') {
                // Harga dasar Storage diasumsikan per 1 Bulan (149rb)
                if (durVal === '1 Minggu') finalPrice = 50000;
                else if (durVal === '2 Minggu') finalPrice = 90000;
                else if (durVal === '3 Minggu') finalPrice = 120000;
                else if (durVal === '1 Bulan') finalPrice = sBasePrc;
                else if (durVal === '2 Bulan') finalPrice = sBasePrc * 2;
            } 
            else if (sType === 'weekly') {
                // Harga dasar Luggage diasumsikan per 1 Minggu (50rb)
                let multiplier = 1;
                if (durVal === '1 Minggu') multiplier = 1;
                else if (durVal === '2 Minggu') multiplier = 2;
                else if (durVal === '3 Minggu') multiplier = 3;
                else if (durVal === '1 Bulan') multiplier = 3.5; // Diskon dikit
                else if (durVal === '2 Bulan') multiplier = 7;
                
                finalPrice = sBasePrc * multiplier;
            }

            sTotalPrc = finalPrice;
            document.getElementById('priceDisplay').innerText = 'Rp ' + finalPrice.toLocaleString('id-ID');
        }

        // Fungsi GPS
        function getGPS() {
            const btn = document.getElementById('gBtn');
            const addr = document.getElementById('userAddress');

            if (navigator.geolocation) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mencari Lokasi Akurat...';
                
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                        const d = await res.json();
                        addr.value = d.display_name;
                        btn.innerHTML = '<i class="fas fa-check"></i> Lokasi Ditemukan!';
                        btn.style.background = '#D1FAE5';
                    } catch (e) {
                        addr.value = `Koordinat: ${pos.coords.latitude}, ${pos.coords.longitude} (Isi detail manual ya)`;
                        btn.innerHTML = 'Gagal ambil nama jalan';
                    }
                }, (err) => {
                    alert("Pastikan GPS HP aktif!");
                    btn.innerHTML = '<i class="fas fa-redo"></i> Coba Lagi';
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                alert("Browser tidak mendukung GPS");
            }
        }
    </script>

    <!-- SCRIPT 2: MODULE FIREBASE (Hanya untuk simpan data) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAXN8xeNxHwbBxSzMM3c5wpJsoOkfr9LSs",
            authDomain: "titip-salatiga.firebaseapp.com",
            projectId: "titip-salatiga",
            storageBucket: "titip-salatiga.firebasestorage.app",
            messagingSenderId: "74240158872",
            appId: "1:74240158872:web:5c0fcc17c7071eae5a62b1"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase Connected");
        } catch (e) { console.error("Firebase Error:", e); }

        window.handleBooking = async () => {
            const name = document.getElementById('userName').value;
            const phone = document.getElementById('userPhone').value;
            const addr = document.getElementById('userAddress').value;
            const land = document.getElementById('userLandmark').value;
            const btn = document.getElementById('submitBtn');
            
            // Ambil durasi jika inputnya terlihat
            let durationVal = "-";
            if (document.getElementById('durationBox').style.display !== 'none') {
                durationVal = document.getElementById('userDuration').value;
            }

            if(!name || !phone || !addr) return alert("Lengkapi data nama, WA, dan alamat dulu ya!");
            if(!sSvc) return alert("Pilih layanan dulu!");

            btn.disabled = true; 
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Lagi proses...';

            try {
                let orderID = "OFFLINE";
                if (db) {
                    const docRef = await addDoc(collection(db, "orders"), {
                        nama: name, wa: phone, alamat: addr, patokan: land,
                        layanan: sSvc, durasi: durationVal, harga: sTotalPrc, time: serverTimestamp()
                    });
                    orderID = docRef.id.substring(0,5).toUpperCase();
                }

                // Format Pesan WA Lengkap
                const myWA = "62895330091464"; 
                // Ganti %0a jadi \n dan encode seluruh text biar karakter #, spasi, enter aman
                let text = `*ORDER #TS-${orderID}*\n`;
                text += `Halo Titip Salatiga! Saya mau booking:\n\n`;
                text += `üì¶ Layanan: *${sSvc}*\n`;
                if(durationVal !== "-") text += `‚è≥ Durasi: ${durationVal}\n`;
                text += `üí∞ Estimasi: Rp ${sTotalPrc.toLocaleString('id-ID')}\n\n`;
                text += `üë§ Nama: ${name}\n`;
                text += `üì± WA: ${phone}\n`;
                text += `üìç Alamat: ${addr}\n`;
                text += `üè† Patokan: ${land || '-'}`;
                
                // PENTING: encodeURIComponent agar # dan spasi tidak memotong link
                window.location.href = `https://wa.me/${myWA}?text=${encodeURIComponent(text)}`;
                
            } catch (e) {
                console.error(e);
                // Fallback Offline
                const myWA = "62895330091464"; 
                let text = `*ORDER MANUAL*\nHalo Titip Salatiga! Saya mau booking *${sSvc}*.\n\nNama: ${name}\nDurasi: ${durationVal}\nHarga: ${sTotalPrc}\nAlamat: ${addr}`;
                window.location.href = `https://wa.me/${myWA}?text=${encodeURIComponent(text)}`;
                
                btn.disabled = false; 
                btn.innerHTML = '<i class="fab fa-whatsapp"></i> Konfirmasi Booking ke WA';
            }
        };
    </script>
</body>
</html>
